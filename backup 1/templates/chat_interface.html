<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Esperança - Assistente da Igreja Esperança Pontal Sul</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Esperança: Assistente da Igreja Esperança Pontal Sul</h1>
    
    <div id="chat-container">
        <div id="chat-box">
            <div class="mensagem ia">
                <strong>Esperança:</strong> {{ saudacao }}
            </div>
        </div>

        <div id="input-area">
            <input type="text" id="pergunta-input" placeholder="Digite sua pergunta aqui..." onkeypress="if(event.keyCode == 13) enviarMensagem()">
            <button onclick="enviarMensagem()">Enviar</button>
        </div>
    </div>

    <script>
        // Função principal para enviar a pergunta para a API
        function enviarMensagem() {
            const inputElement = document.getElementById('pergunta-input');
            const pergunta = inputElement.value.trim();
            
            if (!pergunta) return;

            // 1. Exibir a mensagem do usuário no chat
            adicionarMensagem(pergunta, 'usuario');
            inputElement.value = ''; 

            // 2. Exibir mensagem de espera da IA
            const ia_loading_id = adicionarMensagem("Pensando na melhor resposta...", 'ia', true);

            // 3. Enviar a pergunta para o nosso backend Flask via API
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pergunta: pergunta })
            })
            .then(response => response.json())
            .then(data => {
                // 4. Receber e exibir a resposta
                removerMensagem(ia_loading_id); 
                
                if (data.status === 'sucesso') {
                    adicionarMensagem(data.resposta, 'ia');
                } else {
                    adicionarMensagem(`Erro: ${data.erro}`, 'ia');
                }
            })
            .catch(error => {
                removerMensagem(ia_loading_id); 
                adicionarMensagem('Erro de conexão com o servidor.', 'ia');
                console.error('Erro na requisição:', error);
            });
        }

        // Função utilitária para adicionar mensagens ao chat
        function adicionarMensagem(texto, tipo, is_loading = false) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.classList.add('mensagem', tipo);
            
            if (tipo === 'ia') {
                // Substitui quebras de linha (\n) por <br> para formatação
                div.innerHTML = `<strong>Esperança:</strong> ${texto.replace(/\n/g, '<br>')}`;
            } else {
                div.textContent = texto;
            }

            if (is_loading) {
                const id = 'loading-' + Date.now();
                div.id = id;
                return id; 
            }

            chatBox.appendChild(div);
            // Rolagem automática para a última mensagem
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removerMensagem(id) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.remove();
            }
        }
    </script>
</body>
</html>